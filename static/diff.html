<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diff</title>
<link rel="stylesheet" href="../../style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs/loader.min.js"></script>
</head>
<body>
<div class="loading">Loading...</div>
<div class="diff"></div>
<script>
require.config({ paths: { vs: '../../vs' } });

function xhr(url) {
    var req = null;
    return new Promise(
        function (c, e) {
            req = new XMLHttpRequest();
            req.onreadystatechange = function () {
                if (req._canceled) {
                    return;
                }

                if (req.readyState === 4) {
                    if ((req.status >= 200 && req.status < 300) || req.status === 1223) {
                        c(req);
                    } else if (req.status == 404) {
                        c(req);
                    } else {
                        e(req);
                    }
                    req.onreadystatechange = function () {};
                }
            };

            req.open('GET', url, true);
            req.responseType = '';

            req.send(null);
        },
        function () {
            req._canceled = true;
            req.abort();
        }
    );
}

require(['vs/editor/editor.main'], function () {
    var diffEditor = monaco.editor.createDiffEditor(document.querySelector('.diff'), {
        enableSplitViewResizing: false,
        renderSideBySide: true,
        readOnly: true,
        automaticLayout: true,
        scrollBeyondLastLine: false,
        minimap: {
            enabled: false
        }
    });

    document.querySelector('.loading').style.display = 'block';

    let params = new URLSearchParams(window.location.search);

    modifiedPath = "https://raw.githubusercontent.com/ilyabirman/Aegea-Comparisons/" + params.get('tag2') + "/" + params.get('file');

    originalFile = params.get('file');
    if (params.get('oldFile')) {
        originalFile = params.get('oldFile');
    }

    originalPath = "https://raw.githubusercontent.com/ilyabirman/Aegea-Comparisons/" + params.get('tag1') + "/" + originalFile;

    Promise.all([xhr(originalPath), xhr(modifiedPath)]).then(function (r) {
        var originalTxt = r[0].responseText;
        var modifiedTxt = r[1].responseText;

        if (r[0].status == 404) {
            originalTxt = "";
        }
        if (r[1].status == 404) {
            modifiedTxt = "";
        }

        document.querySelector('.loading').style.display = 'none';
        diffEditor.setModel({
            original: monaco.editor.createModel(originalTxt, 'php'),
            modified: monaco.editor.createModel(modifiedTxt, 'php')
        });
    });
});
</script>
</body>
</html>
